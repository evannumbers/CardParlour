<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/style/player.css">
    <link rel="stylesheet" href="/style/default.css">
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">
    <script src="http://code.jquery.com/jquery-1.11.2.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
  </head>
  <script>

  /* Card class */
  var Card = function(id, text) {
    this.id = id;
    this.text = text;
  }

  /* Client class */
  var Client = {
    name: "",
    state: "Not Connected",
    selectedCard: -1,
    hand: []
  }

  </script>
  <body>
      <div class="header_container" id="header">
        Join the Game!
      </div>

      <!-- Startup screen -->
      <div id="startup" data-role="main" class="ui-content">
        <form id="get_name" action="">
          <label for="user">First name:</label>
          <input type="text" name="user" id="user"/>
          <button>Join</button>
        </form>
      </div>

      <!-- Gameplay screen -->
      <div id="scroll" class="card_container" style="display:none">
      </div>

      <div style="display:none" class="footer" id="footer">
        <form id="send_card" action="">
          <button id="send_button">Send</button>
        </form>
      </div>





    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script>

      var socket = io();

      /* Given the id of the card, find the card in the client's hand.
       * If the card does not exist, return -1.
       */
      function indexByCardID(id)
      {
        for(i = 0; i < Client.hand.length; i++)
        {
          card = Client.hand[i];
          if(card.id == id)
          {
            return i;
          }
        }
        return -1;
      }

      /* Given the update state message, hide or show the send button depending
       * on the new state.
       */
      function updateSend(msg)
      {
        var send = document.getElementById("footer");
        /* In states 2 and 5, the client can select a card to play */
        if(msg == 1 || msg == 4)
        {
          $("#footer").css("display", 'block');
        }
        else 
        {
          $("#footer").css("display", 'none');
        }
      }

      /* Given the id and text for a card, add this card object to the HTML
       * and create a event handler for the card to determine selected card.
       */
      function addCard(id, text)
      {
        /* Create the new card's HTML */
        div = "<div id='" + id + "' class='player_card'>" + text + "</div>";
        $(".card_container").append(div);

        /* Make an event handler to deselect the previous card, and select
         * the current card.
         */
        $("#"+id).click(function() {
          $("#"+Client.selectedCard).css("background-color", "#eeeeee");
          Client.selectedCard = id;
          $("#"+id).css("background-color", "#cccccc");
        });
      }

      /* At the initial loading screen, if the user submits their name,
       * emit a message to the server with the name
       */
      $('#get_name').submit(function()
      {
        socket.emit('join', $('#user').val());
        $("#get_name").hide(); //TODO: move this
        Client.name = $('#user').val();
        return false;
      });

      /* If the client presses the send card button, send the currently
       * selected card.
       */
      $('#send_card').submit(function()
      {
        /* Not yet selected */
        if(Client.selectedCard < 0) {
          return false;
        }

        socket.emit('play', Client.selectedCard);
        return false;
      });

      /* Event handler for when the clients game state changes */
      socket.on('update state', function(msg) {
        console.log(msg);
        messages = ["You are not playing", "Select a card to play",
                    "You are the card Czar, please wait...",
                    "Please wait for the card Czar to choose...",
                    "You are the card Czar, please choose a card..."];

        /* Update header with new state */
        document.getElementById("header").innerHTML = (Client.name + ", "
                                                        + messages[msg]);

        /* In state 0, the user should see the sign in view */
        var startup = document.getElementById("#startup");
        if(msg == 0)
        {
          $("#scroll").css("display", "none");
          $("#startup").css("display", "block");
        } 
        else 
        {
          $("#scroll").css("display", "block");
          $("#startup").css("display", "none");
        }

        /* Update the send button */
        updateSend(msg);
      });
      
      /* Event handler for when the client receives a card. Insert this card
       * into the hand, and place it in the HTML.
       */
      socket.on('deal', function(id, text) {
        Client.hand.push(new Card(id,text));
        console.log(Client.hand);
        addCard(id, text);
      });

      /* Event handler for when the client has successfully played a card.
       * Remove the card from the hand and HTML.
       */
      socket.on('remove card', function(id) {
        if(id == Client.selectedCard)
        {
          Client.selectedCard = -1;
        }

        /* Find the location in the hand */
        index = indexByCardID(id);
        if(index > -1)
        {
          /* Remove from hand */
          console.log(Client.hand);
          Client.hand.splice(index, 1);
          console.log(Client.hand);

          /* Find in HTML */
          var divMatch = "#" + id;
          $(divMatch).remove();
        }
        else
        {
          console.log("Card does not exist.");
        }
      });
    </script>

  </body>
</html>
